kind: pipeline
name: build

platform:
  os: linux
  arch: amd64

steps:

# TODO: tests would be a good idea
# - name: tests
#   image: golang:1.14
#   commands:
#   - go get -u github.com/rakyll/gotest
#   - gotest -v ./...

- name: tag
  image: bitnami/git
  commands:
  - git fetch --tags --verbose
  - TAG=$(git describe --tags --always --dirty)
  - printf "$${TAG}" > .tags
  - cat .tags
  - env | sort

- name: tag-release
  image: bitnami/git
  commands:
  - TAG=$(git describe --tags --always --dirty)
  - printf "release-$${TAG},latest" > .tags
  - cat .tags
  when:
    event:
    - tag

# - name: publish
#   image: plugins/docker
#   settings:
#     dockerfile: Dockerfile
#     password:
#       from_secret: dockerhub-pass
#     repo: "${CI_REPO}"
#     username: digtux
#   when:
#     branch:
#     - master
#     - develop
#     - feature/*

trigger:
  branch:
  - develop
  - master
  - feature/*
  event:
  - push
  - tag

